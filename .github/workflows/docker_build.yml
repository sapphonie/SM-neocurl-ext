on:
  push
jobs:
    compile:
        name: Compile extension in docker
        runs-on: ubuntu-latest
        steps:
          - name: Check out the repo
            uses: actions/checkout@v2

          - name: Run the build process with Docker
            uses: addnab/docker-run-action@v3
            with:
                image: registry.gitlab.steamos.cloud/steamrt/sniper/sdk:latest
                options: -v ${{ github.workspace }}:/mnt/curl
                run: |
                    bash /mnt/curl/ci/_docker_script.sh

          - name: Zip packages
            run: |
              pwd
              ls -la
              mkdir build
              cd build
              mkdir scripting/include -p
              mkdir extensions
              mkdir plugins
              cp ../Release/curl.ext.so extensions/ -v
              7za a -r build/sm-neocurl.zip scripting/ plugins/ extensions/
              ls -la
              pwd

          #- name: Set Commit Hash
          #  id: commit_info
          #  run: echo "::set-output name=sha_short::$(git rev-parse --short HEAD)"
          
          - name: Set Commit Hash
            id: getsha
            run: echo "{sha_short}=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

          - name: Create Release
            id: create_release
            uses: actions/create-release@v1
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            with:
              tag_name: ${{ steps.getsha.outputs.sha_short }}
              release_name: ${{ steps.getsha.outputs.sha_short }}
              draft: false
              prerelease: true

          - name: Upload Release Asset
            id: upload-release-asset
            uses: actions/upload-release-asset@v1
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            with:
              upload_url: ${{ steps.create_release.outputs.upload_url }} # This pulls from the CREATE RELEASE step above, referencing it's ID to get its outputs object, which include a `upload_url`. See this blog post for more info: https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps
              asset_path: ./build/sm-neocurl.zip
              asset_name: sm-neocurl.zip
              asset_content_type: application/zip
